<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OTP Verification</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Shared styles (your existing form.css) -->
  <link href="../../css/form.css" rel="stylesheet">

  <style>
    /* Page-specific tweaks while still using your shared CSS variables and classes */
    .otp-card {
      width:100%;
      max-width:720px;
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid var(--glass-border);
      box-shadow: 0 12px 36px rgba(2,6,23,0.45);
      padding:1.4rem;
    }

    .otp-instructions { color: var(--muted); margin-bottom:0.6rem; }

    /* OTP inputs row */
    .otp-inputs {
      display:flex;
      gap:0.6rem;
      justify-content:center;
      margin:1rem 0 0.6rem;
    }
    .otp-input {
      width:64px;
      height:64px;
      text-align:center;
      font-size:1.4rem;
      font-weight:700;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.02);
      color:var(--text);
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    .otp-input:focus {
      outline:none;
      border-color:var(--accent);
      box-shadow: 0 10px 30px rgba(0,212,255,0.06);
      background: rgba(255,255,255,0.02);
    }

    /* smaller on mobile */
    @media(max-width:420px){
      .otp-input { width:52px; height:52px; font-size:1.2rem; }
      .otp-inputs { gap:0.45rem; }
    }

    .resend-row { display:flex; gap:1rem; align-items:center; justify-content:center; margin-top:0.6rem; }
    .resend-btn { background:transparent; border:none; color:var(--accent); font-weight:700; }
    .resend-btn[disabled] { color: rgba(157,220,255,0.5); cursor:default; }

    .small-note { font-size:0.88rem; color:var(--muted); }

    /* success / error */
    .otp-error { color:#ffb3b3; font-weight:600; margin-top:0.5rem; text-align:center; }
    .otp-success { color:#b7ffd9; font-weight:600; margin-top:0.5rem; text-align:center; }
  </style>
</head>
<body>
  <div class="container-center" aria-live="polite">
    <div class="float-shape shape-1" aria-hidden="true"></div>
    <div class="float-shape shape-2" aria-hidden="true"></div>
    <div class="float-shape shape-3" aria-hidden="true"></div>

    <div class="otp-card" role="region" aria-label="OTP verification">
      <div class="brand" style="margin-bottom:0.6rem;">
        <div class="logo">HS</div>
        <div>
          <div style="font-weight:700; color:#fff;">HostelSpace</div>
          <div class="muted" style="font-size:0.88rem;">Secure sign-in</div>
        </div>
      </div>

      <h1 style="font-size:1.18rem; margin-bottom:0.25rem;">Enter verification code</h1>
      <p class="otp-instructions small-note">We sent a 4‑digit code to <strong id="maskedEmail">you@example.com</strong>. Enter it below to continue.</p>

      <!-- Account type (optional) -->
      <div style="margin-bottom:0.6rem; display:flex; align-items:center; gap:1rem; justify-content:center;">
        <div class="segmented-toggle" role="tablist" aria-label="Account type">
          <button type="button" class="active" data-value="student" id="segStudent">Student</button>
          <button type="button" data-value="agent" id="segAgent">Agent</button>
        </div>
      </div>

      <!-- OTP inputs -->
      <div class="otp-inputs" role="group" aria-label="4 digit code">
        <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input" id="otp-1" aria-label="Digit 1" autocomplete="one-time-code" />
        <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input" id="otp-2" aria-label="Digit 2" autocomplete="one-time-code" />
        <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input" id="otp-3" aria-label="Digit 3" autocomplete="one-time-code" />
        <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input" id="otp-4" aria-label="Digit 4" autocomplete="one-time-code" />
      </div>

      <div class="text-center">
        <button id="verifyBtn" class="submit-btn" style="min-width:160px;">Verify code</button>
      </div>

      <div class="resend-row">
        <div class="small-note">Didn't receive it?</div>
        <button id="resendBtn" class="resend-btn" type="button" disabled>Resend code (<span id="timer">00:30</span>)</button>
      </div>

      <div id="feedback" aria-live="assertive"></div>

      <div class="text-center" style="margin-top:0.9rem;">
        <a href="#" id="changeEmail" class="text-decoration-none" style="color:var(--accent); font-weight:600;">Use a different email</a>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Elements
    const inputs = Array.from(document.querySelectorAll('.otp-input'));
    const verifyBtn = document.getElementById('verifyBtn');
    const resendBtn = document.getElementById('resendBtn');
    const timerEl = document.getElementById('timer');
    const feedback = document.getElementById('feedback');
    const segStudent = document.getElementById('segStudent');
    const segAgent = document.getElementById('segAgent');

    let accountType = 'student';
    function setActiveSegment(btn) {
      [segStudent, segAgent].forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      accountType = btn.dataset.value;
    }
    segStudent.addEventListener('click', () => setActiveSegment(segStudent));
    segAgent.addEventListener('click', () => setActiveSegment(segAgent));

    // Focus behavior and keyboard handling
    inputs.forEach((input, idx) => {
      input.addEventListener('input', (e) => {
        const val = e.target.value.replace(/\D/g,'').slice(0,1);
        e.target.value = val;
        if (val && idx < inputs.length - 1) inputs[idx + 1].focus();
        updatePasteBuffer();
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && idx > 0) {
          inputs[idx - 1].focus();
        } else if (e.key === 'ArrowLeft' && idx > 0) {
          inputs[idx - 1].focus();
        } else if (e.key === 'ArrowRight' && idx < inputs.length - 1) {
          inputs[idx + 1].focus();
        }
      });

      // support paste on each input (for some browsers)
      input.addEventListener('paste', handlePaste);
    });

    // Allow paste of full code into any input
    function handlePaste(e) {
      e.preventDefault();
      const paste = (e.clipboardData || window.clipboardData).getData('text').trim();
      const digits = paste.replace(/\D/g, '').slice(0,4).split('');
      if (digits.length === 0) return;
      inputs.forEach((inp, i) => inp.value = digits[i] || '');
      // focus last filled or verify
      const lastFilled = Math.min(digits.length - 1, inputs.length - 1);
      inputs[lastFilled].focus();
      updatePasteBuffer();
    }

    function updatePasteBuffer() {
      feedback.textContent = '';
    }

    // Timer for resend
    let countdown = 30; // seconds
    let timerId = null;
    function startTimer(seconds = 30) {
      clearInterval(timerId);
      countdown = seconds;
      resendBtn.disabled = true;
      updateTimerDisplay();
      timerId = setInterval(() => {
        countdown--;
        updateTimerDisplay();
        if (countdown <= 0) {
          clearInterval(timerId);
          resendBtn.disabled = false;
          timerEl.textContent = '00:00';
          resendBtn.textContent = 'Resend code';
        }
      }, 1000);
    }
    function updateTimerDisplay() {
      const mm = String(Math.floor(countdown / 60)).padStart(2,'0');
      const ss = String(countdown % 60).padStart(2,'0');
      timerEl.textContent = `${mm}:${ss}`;
      resendBtn.textContent = `Resend code (${timerEl.textContent})`;
    }

    // Simulated backend code for demo
    // In real app: send code to email and verify on server
    let currentOtp = generateOtp();
    function generateOtp() {
      const code = Math.floor(1000 + Math.random() * 9000).toString();
      console.log('DEBUG: OTP generated (sent to email):', code);
      return code;
    }

    // Resend handler
    resendBtn.addEventListener('click', () => {
      resendBtn.disabled = true;
      currentOtp = generateOtp();
      feedback.innerHTML = '<div class="otp-success">A new code was sent to your email.</div>';
      startTimer(30);
    });

    // Verify handler
    verifyBtn.addEventListener('click', () => {
      const code = inputs.map(i => i.value).join('');
      if (code.length < 4) {
        feedback.innerHTML = '<div class="otp-error">Please enter the 4-digit code.</div>';
        return;
      }
      // Simulate server verification
      verifyBtn.disabled = true;
      verifyBtn.textContent = 'Verifying...';
      setTimeout(() => {
        verifyBtn.disabled = false;
        verifyBtn.textContent = 'Verify code';
        if (code === currentOtp) {
          feedback.innerHTML = '<div class="otp-success">Code verified — signing you in.</div>';
          // proceed to next step (redirect or callback)
        } else {
          feedback.innerHTML = '<div class="otp-error">Invalid code. Try again or resend.</div>';
          inputs.forEach(i => i.value = '');
          inputs[0].focus();
        }
      }, 800);
    });

    // Initialize
    inputs[0].focus();
    startTimer(30);

    // Optional: expose a function to set masked email from previous page
    // Example: window.setMaskedEmail('a***@example.com')
    window.setMaskedEmail = function(email) {
      const el = document.getElementById('maskedEmail');
      if (!email) return;
      // simple mask if full email provided
      const parts = email.split('@');
      if (parts.length === 2) {
        const name = parts[0];
        const domain = parts[1];
        const maskedName = name.length > 2 ? name[0] + '***' + name.slice(-1) : name[0] + '*';
        el.textContent = maskedName + '@' + domain;
      } else {
        el.textContent = email;
      }
    };

    // For demo: set a sample masked email (remove in production)
    window.setMaskedEmail('you@example.com');
  </script>
</body>
</html>
